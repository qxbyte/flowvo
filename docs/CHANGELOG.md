# FlowVO 更新日志

## 2025-06-02 (下午修复)

### 🔧 关键修复：OpenAI嵌入模型Bean创建失败问题

**问题现象**：
- 启动时报错：`Error creating bean with name 'embeddingModel'`
- 日志显示：`OpenAiApi Bean是否可用: false`
- 即使OpenAI聊天模型正常工作，嵌入模型却无法初始化

**根本原因**：
- Spring AI的自动配置需要特定的条件才能创建OpenAiApi Bean
- 我们的VectorStoreConfig过度复杂，干扰了Spring AI的正常自动配置
- `.env`文件中的环境变量在IDEA中可能没有正确加载

**技术解决方案**：
1. **简化VectorStoreConfig**：
   - 移除复杂的手动Bean创建逻辑
   - 使用`@ConditionalOnProperty`条件化创建自定义Bean
   - 让Spring AI的自动配置在SPRING_AI模式下正常工作

2. **配置优化**：
   ```java
   @Bean
   @Primary
   @ConditionalOnProperty(name = "embedding.type", havingValue = "EXTERNAL")
   public EmbeddingModel embeddingModel(EmbeddingClient embeddingClient) {
       // 只在EXTERNAL模式时创建自定义实现
   }
   ```

3. **环境变量配置**：
   - 修复`.env`文件中的`OPENAI_BASE_URL`格式错误
   - 确保IDEA能正确加载环境变量

**配置方式对比**：

| 模式 | embedding.type | Bean创建方式 | 说明 |
|------|----------------|--------------|------|
| 本地嵌入 | EXTERNAL | 自定义ExternalEmbeddingModelAdapter | 使用Python嵌入服务 |
| OpenAI嵌入 | SPRING_AI | Spring AI自动配置 | 使用OpenAI API |

**用户操作**：
1. 确保`.env`文件格式正确
2. 在IDEA的Run Configuration中正确配置环境变量
3. 根据需要修改`application.yml`中的`embedding.type`

**技术价值**：
- 解决了Spring AI自动配置干扰问题
- 保持了灵活的嵌入模型切换能力
- 简化了配置复杂度，提高了系统稳定性

## 2025-06-02

### 🔧 重大修复：文档上传嵌入模型配置生效问题

**问题现象**：
- yml配置的`embedding.type`设置为EXTERNAL时，`vectorStore.add()`仍然调用OpenAI嵌入模型
- 即使断点跟踪显示走了本地嵌入模型逻辑，但实际向量化时还是使用OpenAI API
- 导致在完全离线环境下无法正常使用文档上传功能

**根本原因**：
- Spring AI的VectorStore在调用`add()`方法时，使用的是自己内部注入的EmbeddingModel实例
- 仅仅在DocumentService中判断配置是不够的，因为VectorStore有自己的EmbeddingModel依赖
- Spring AI的自动配置会根据classpath创建默认的OpenAI EmbeddingModel

**技术解决方案**：
1. **配置层解决**：在VectorStoreConfig中使用`@Primary`注解创建自定义EmbeddingModel Bean
2. **适配器模式**：创建ExternalEmbeddingModelAdapter将EmbeddingClient适配为Spring AI标准接口
3. **依赖注入覆盖**：让Spring AI的VectorStore自动使用我们配置的EmbeddingModel

**代码架构**：
```java
@Bean
@Primary
public EmbeddingModel embeddingModel() {
    if (embeddingConfig.getType() == EXTERNAL) {
        return new ExternalEmbeddingModelAdapter(embeddingClient);
    } else {
        return new OpenAiEmbeddingModel(openAiApi);
    }
}
```

**关键技术点**：
- **Spring AI兼容性**：ExternalEmbeddingModelAdapter完全实现EmbeddingModel接口
- **向量维度一致**：确保外部服务和OpenAI都输出1536维向量
- **元数据保持**：保持Document的元数据在向量化过程中不丢失
- **错误处理**：完善的异常处理和日志记录

**用户价值**：
- ✅ **真正的配置切换**：yml中的`embedding.type`配置现在完全生效
- ✅ **完全离线运行**：EXTERNAL模式下不再依赖任何外部API
- ✅ **无缝兼容**：两种模式的向量数据完全兼容，可以混合搜索
- ✅ **性能优化**：本地嵌入服务避免网络延迟和API限制

**升级步骤**：
1. 确保Python嵌入服务运行在localhost:8000
2. 将`application.yml`中的`embedding.type`设置为`EXTERNAL`
3. 重启agents服务
4. 验证文档上传不再调用OpenAI API

**测试验证**：
- 断网环境下文档上传成功
- 日志显示使用外部嵌入服务
- 向量搜索结果与之前OpenAI模式一致

## 2025-06-02

### 🎨 系统主题自动检测优化

**功能概述**：
前端应用现在能够智能检测用户的系统主题偏好（浅色/深色模式），并自动应用相应的界面主题，提供更加个性化和舒适的用户体验。

**技术架构**：

1. **初始化脚本优化** (`index.html`)：
   - 使用`window.matchMedia('(prefers-color-scheme: dark)')`API检测系统主题
   - 实现首次访问时的自动主题设置
   - 添加系统主题变化的实时监听

2. **主题管理Hook** (`useSystemColorMode.ts`)：
   - 封装系统主题检测逻辑
   - 管理自动跟随和手动设置的切换
   - 提供主题状态的响应式更新

3. **用户界面增强** (`Header.tsx`)：
   - 简单切换按钮升级为功能丰富的下拉菜单
   - 提供三种主题选项：浅色模式、深色模式、跟随系统
   - 智能图标显示：跟随系统时根据当前实际主题显示对应图标
   - 当前选中项的视觉反馈

4. **应用集成** (`main.tsx` & `App.tsx`)：
   - ColorModeScript确保SSR兼容性
   - 系统主题检测的应用级集成

**用户体验**：
- **无感切换**：首次访问自动适配系统主题，无需手动设置
- **实时同步**：系统主题变更时应用界面实时跟随变化
- **灵活控制**：用户可随时切换到固定主题或重新跟随系统
- **视觉一致**：主题切换动画流畅，避免闪烁现象

**跨平台支持**：
- **桌面端**：Windows、macOS、Linux系统主题检测
- **移动端**：iOS、Android深色模式适配
- **浏览器兼容**：Chrome、Firefox、Safari、Edge全面支持

**配置说明**：
```typescript
// 三种主题模式
- 'light': 强制浅色主题
- 'dark': 强制深色主题  
- 'system': 跟随系统主题（默认）
```

**技术细节**：
- 使用Chakra UI的ColorMode系统
- localStorage持久化用户偏好设置
- 防抖处理避免频繁切换造成的性能问题
- 完善的TypeScript类型支持

**后续计划**：
- 考虑添加更多主题色彩选项
- 集成用户个人偏好设置页面
- 支持自定义主题配置

## 2025-06-02

### 📄 文档上传功能优化

**主要更新**：
- 修复了文档上传时的重复处理问题
- 优化了向量化服务的错误处理机制  
- 改进了用户界面的加载状态显示

## 2025年6月2日 - 本地模型离线运行优化 🔧

### 🎯 主要改进

#### 1. **本地模型优先策略**
- ✅ **离线运行支持**：优先使用本地模型，无需VPN和网络连接
- ✅ **模型路径优化**：自动检测项目目录下的`models/all-mpnet-base-v2`
- ✅ **智能降级机制**：本地模型失败时自动切换到远程模型
- ✅ **模型文件验证**：检查safetensors和pytorch_model.bin文件完整性

#### 2. **模型加载策略优化**
```python
# 模型加载优先级
1. 本地模型 (离线优先) → models/all-mpnet-base-v2
2. 远程主模型 → BAAI/bge-large-en-v1.5
3. 远程备用模型 → sentence-transformers/all-mpnet-base-v2
```

#### 3. **路径配置改进**
- **绝对路径解析**：确保从任意目录启动都能正确找到模型
- **配置调试信息**：启动时输出详细的路径信息用于问题排查
- **文件完整性检查**：支持safetensors格式（418MB）和pytorch格式
- **日志目录自动创建**：确保日志文件路径正确

### 🔧 技术特性

#### **本地模型管理**
- **模型下载工具**：`python/download_model.py`自动下载完整模型
- **完整性验证**：检查模型文件大小，避免损坏的134B小文件
- **格式支持**：优先使用safetensors格式，兼容pytorch_model.bin
- **离线标识**：API响应中明确显示`"load_type": "local_offline"`

#### **路径解析优化**
```python
# 自动路径配置
BASE_DIR = os.path.dirname(os.path.abspath(__file__))  # python目录绝对路径
PROJECT_ROOT = os.path.dirname(BASE_DIR)              # 项目根目录
LOCAL_MODEL_PATH = PROJECT_ROOT/models/all-mpnet-base-v2
```

#### **启动调试信息**
- **路径状态检查**：显示所有关键路径的存在状态
- **模型文件验证**：检查config.json和权重文件
- **加载结果确认**：明确显示使用的模型类型和来源

### 🚀 使用改进

#### **离线运行确认**
```json
// API健康检查响应
{
  "model_info": {
    "model_name": "all-mpnet-base-v2",
    "model_path": "/path/to/models/all-mpnet-base-v2",
    "load_type": "local_offline",
    "status": "local_loaded"
  }
}
```

#### **模型状态API增强**
```json
// 根路径API新增本地模型状态
{
  "local_model_status": {
    "available": true,
    "path": "/path/to/models/all-mpnet-base-v2",
    "model_name": "all-mpnet-base-v2"
  },
  "model_loading_strategy": {
    "priority": "local_first",
    "offline_mode": true
  }
}
```

### 🔄 模型下载与管理

#### **自动下载脚本**
```bash
# 下载完整模型到本地
cd python
source ../embedding_env/bin/activate
python download_model.py
```

#### **文件完整性验证**
- **正确文件大小**：model.safetensors应为418MB
- **错误文件检测**：自动识别134B的损坏文件
- **重新下载机制**：损坏文件自动清理并重新下载

### 📊 性能优势

| 特性 | 使用远程模型 | 使用本地模型 |
|------|-------------|-------------|
| 网络依赖 | 需要VPN/网络 | 完全离线 |
| 启动速度 | 较慢(下载) | 快速启动 |
| 稳定性 | 依赖网络状况 | 高度稳定 |
| 隐私保护 | 数据传输 | 本地处理 |
| 部署复杂度 | 需要网络配置 | 简单部署 |

### 🎯 解决的问题

#### **网络连接问题**
- ❌ **VPN依赖**：不再需要VPN连接HuggingFace
- ❌ **网络超时**：避免网络不稳定导致的模型加载失败
- ❌ **下载中断**：预下载模型，避免运行时下载问题

#### **文件损坏问题**
- ❌ **HeaderTooLarge错误**：检测并修复损坏的模型文件
- ❌ **空文件问题**：验证文件大小，确保完整性
- ❌ **格式兼容**：同时支持新旧模型文件格式

#### **路径问题**
- ❌ **相对路径错误**：使用绝对路径，确保从任意目录启动都正常
- ❌ **工作目录依赖**：不再依赖特定的工作目录
- ❌ **日志路径错误**：自动创建日志目录

### 🔧 技术实现

#### **智能模型检测**
```python
def check_local_model_available() -> bool:
    # 检查配置文件
    config_file = os.path.join(LOCAL_MODEL_PATH, 'config.json')
    
    # 检查权重文件（优先safetensors）
    safetensors_file = os.path.join(LOCAL_MODEL_PATH, 'model.safetensors')
    pytorch_file = os.path.join(LOCAL_MODEL_PATH, 'pytorch_model.bin')
    
    # 验证文件大小（至少1KB，避免空文件）
    return file_size > 1024
```

#### **加载策略优化**
```python
def load_embedding_model():
    # 1. 优先尝试本地模型 (local_files_only=True)
    # 2. 失败时尝试远程主模型
    # 3. 最后尝试远程备用模型
    # 4. 所有失败时提供详细错误信息
```

---

**安装文档更新**：
- ✅ **完整部署文档**：添加详细的本地模型下载命令和说明
- ✅ **验证步骤**：提供模型下载验证和健康检查命令
- ✅ **故障排除**：新增本地模型相关问题的完整排错指南
- ✅ **README优化**：在快速启动部分添加本地模型下载提示

**总结**：此次本地模型优化实现了完全离线运行，消除了VPN和网络依赖，显著提升了服务的稳定性和部署便利性。开发者现在可以在任何网络环境下正常使用FlowVO嵌入服务。

## 2025年6月2日 - 嵌入服务重构优化 🤖

### 🎯 主要改进

#### 1. **向量维度标准化**
- ✅ **1536维度向量**：与OpenAI嵌入模型保持一致，提升兼容性
- ✅ **智能维度调整**：自动处理不同模型的维度差异
- ✅ **多模型支持**：主模型失败时自动降级到备用模型
- ✅ **维度转换算法**：支持维度扩展（零填充）和维度截断

#### 2. **服务架构优化**
- **配置类管理**：集中化配置管理，支持灵活调整
- **应用生命周期**：使用FastAPI lifespan管理模型加载和卸载
- **CORS中间件**：支持跨域请求，提升前端集成体验
- **异常处理机制**：完善的错误处理和日志记录

#### 3. **API接口增强**
- **数据验证**：使用Pydantic validators进行严格的输入验证
- **响应模型优化**：增加维度、计数、模型信息等元数据
- **灵活参数支持**：文本切分支持自定义chunk_size和chunk_overlap
- **批量处理优化**：支持最大100个文本的批量处理

### 🔧 技术特性

#### **模型管理**
```python
# 智能模型加载策略
主模型: BAAI/bge-large-en-v1.5 (1024维 -> 1536维)
备用模型: sentence-transformers/all-mpnet-base-v2 (768维 -> 1536维)
维度调整: 自动零填充或截断到1536维
```

#### **性能优化**
- **批量处理**：支持批量文本嵌入，提升吞吐量
- **内存优化**：使用numpy进行向量操作，提升效率
- **异步API**：全异步接口设计，提升并发性能
- **模型缓存**：启动时加载模型，避免重复加载开销

#### **配置管理**
```python
class Config:
    TARGET_DIMENSION: int = 1536      # 与OpenAI一致
    MAX_BATCH_SIZE: int = 100         # 批量处理限制
    MAX_TEXT_LENGTH: int = 8192       # 单文本长度限制
    DEFAULT_CHUNK_SIZE: int = 512     # 默认切分大小
    DEFAULT_CHUNK_OVERLAP: int = 50   # 默认重叠大小
```

### 🚀 API接口优化

#### **增强的响应格式**
```json
{
    "embedding": [0.1, 0.2, ...],     // 1536维向量
    "dimension": 1536,                 // 向量维度
    "model_info": {                    // 模型信息
        "model_name": "BAAI/bge-large-en-v1.5",
        "original_dimension": 1024,
        "target_dimension": 1536,
        "status": "loaded"
    }
}
```

#### **灵活的文本切分**
- **自定义参数**：支持chunk_size和chunk_overlap自定义
- **智能分隔符**：中英文标点符号智能识别
- **参数验证**：确保chunk_overlap小于chunk_size
- **元数据返回**：返回切分数量和原文本长度

#### **健康检查优化**
- **模型状态检测**：验证模型是否正常工作
- **运行时间统计**：显示服务运行时长
- **详细错误信息**：失败时提供具体错误原因
- **服务监控支持**：标准化健康检查响应格式

### 📊 功能对比

| 功能 | 重构前 | 重构后 |
|------|--------|--------|
| 向量维度 | 模型原生维度 | 统一1536维 |
| 错误处理 | 基础异常 | 详细分类处理 |
| 配置管理 | 硬编码 | 配置类管理 |
| 数据验证 | 无验证 | Pydantic验证 |
| 日志记录 | 无日志 | 结构化日志 |
| 模型管理 | 启动加载 | 生命周期管理 |
| API文档 | 基础文档 | 详细响应模型 |
| 监控支持 | 简单健康检查 | 完整监控信息 |

### 🔧 部署和维护

#### **日志管理**
- **文件日志**：`logs/embedding_service.log`
- **控制台日志**：实时输出到控制台
- **日志级别**：INFO级别，包含详细操作信息
- **错误追踪**：异常自动记录，便于问题排查

#### **性能监控**
- **模型信息**：实时显示模型状态和维度信息
- **运行时间**：服务启动后的运行时长
- **请求统计**：每次API调用的处理信息
- **错误统计**：失败请求的详细错误信息

#### **兼容性保证**
- ✅ **API接口不变**：保持原有接口路径和基本功能
- ✅ **向后兼容**：现有客户端代码无需修改
- ✅ **增强功能**：新增参数和响应字段，可选使用
- ✅ **错误处理**：更友好的错误提示和状态码

### 🎯 技术优势

#### **与OpenAI兼容**
- **1536维度**：与OpenAI text-embedding-3-small保持一致
- **标准化接口**：便于切换和比较不同嵌入模型
- **一致性体验**：前端无需关心底层模型差异

#### **企业级特性**
- **高可用性**：主备模型自动切换
- **监控支持**：完整的健康检查和状态监控
- **日志审计**：详细的操作日志记录
- **性能优化**：批量处理和异步接口

#### **开发友好**
- **详细文档**：完整的API文档和响应模型
- **类型安全**：严格的输入输出类型定义
- **错误提示**：清晰的错误信息和处理建议
- **配置灵活**：易于调整的配置参数

---

**总结**：此次嵌入服务重构显著提升了服务的可靠性、性能和可维护性，实现了与OpenAI嵌入模型的维度兼容，为FlowVO平台的向量检索功能提供了更稳定、更标准化的基础服务。

## 2025年6月2日 - README文档重构优化 📚

### 🎯 主要改进

#### 1. **文档结构重新组织**
- ✅ **项目介绍优先**：突出FlowVO的核心特性和价值
- ✅ **架构详解**：详细介绍微服务架构设计和技术选型
- ✅ **功能模块深度说明**：每个模块的技术实现和特色功能
- ✅ **简化部署命令**：将详细部署说明移至专门文档

#### 2. **技术栈详细说明**
- **前端技术栈**：React + TypeScript生态详解
- **后端技术栈**：Spring Boot微服务架构说明
- **AI服务栈**：Python AI处理服务技术介绍
- **数据存储栈**：MySQL、Milvus、Redis等存储方案

#### 3. **架构图和工作流程**
- **系统架构图**：分层架构设计展示
- **Function Call流程图**：智能对话处理机制
- **MCP服务调用流程**：微服务协作机制
- **性能优化策略**：数据库、向量检索、应用层优化

### 🔧 文档优化

#### **内容结构调整**
- **项目概述** → 核心特性突出
- **系统架构** → 微服务设计详解  
- **技术栈** → 分类详细说明
- **功能模块** → 深度技术介绍
- **开发特性** → 开发者友好功能
- **创新亮点** → 项目独特价值
- **性能优化** → 技术优化策略
- **未来规划** → 发展路线图

#### **部署相关简化**
- ✅ **一键启动**：简化为单行命令
- ✅ **链接引导**：指向详细部署文档
- ✅ **核心地址**：仅保留关键访问地址
- ✅ **快速上手**：降低新用户门槛

### 🎨 内容亮点

#### **技术深度**
- **微服务架构图**：清晰的分层设计展示
- **Function Call工作流程**：完整的AI对话处理机制
- **代码示例**：关键技术的代码片段展示
- **性能优化策略**：数据库索引、向量检索等优化方案

#### **功能特色**
- **智能对话系统**：PixelChat引擎详解
- **文档智能处理**：多格式解析能力
- **向量检索引擎**：Milvus集成方案
- **用户管理系统**：完整的认证授权机制

#### **开发体验**
- **智能启动脚本**：健康检查、智能重启
- **开发者友好**：热重载、详细日志
- **生产就绪**：性能优化、安全加固
- **代码规范**：完整的开发指南

### 📋 文档导航优化

```
README.md (项目总览)
├── 项目概述与核心特性
├── 快速启动指南
├── 系统架构详解
├── 技术栈深度介绍
├── 功能模块详解
├── 开发特性说明
├── 创新亮点展示
├── 性能优化策略
├── 未来规划路线图
└── 贡献指南

专门文档链接：
├── docs/完整安装部署文档.md (详细部署)
└── CHANGELOG.md (更新日志)
```

### 🎯 用户体验提升

#### **对于新用户**
- **快速了解**：项目概述和核心特性一目了然
- **技术选型**：清楚了解技术栈和架构设计
- **功能特色**：详细了解平台能力和创新点

#### **对于开发者**
- **架构理解**：微服务设计和数据流转机制
- **技术深度**：每个模块的技术实现细节
- **开发指南**：完整的开发环境和规范说明

#### **对于决策者**
- **技术价值**：创新亮点和技术优势
- **功能完整性**：完整的业务功能模块
- **发展规划**：明确的技术发展路线图

### 🚀 影响和价值

- ✅ **降低学习门槛**：新用户快速理解项目价值
- ✅ **提升开发效率**：开发者快速上手和深入理解
- ✅ **技术传播**：清晰展示技术架构和创新点
- ✅ **社区建设**：完善的贡献指南和开发规范

---

**总结**：此次README重构将FlowVO从一个部署说明文档转变为一个完整的项目技术文档，突出了项目的技术价值、架构设计和创新特色，为用户、开发者和决策者提供了不同层次的信息价值。

## 2025年6月2日 - 启动脚本智能化优化 🚀

### 🎯 主要改进

#### 1. **智能启动脚本优化**
- ✅ **数据库服务保护**：Milvus和嵌入模型服务只在检测不到时才启动
- ✅ **健康检查机制**：增加服务健康状态检测，确保服务正常运行
- ✅ **智能重启模式**：应用服务支持直接重启，无需手动停止
- ✅ **多种启动模式**：支持常规、重启、跳过数据库、强制等模式

#### 2. **新增启动参数**
```bash
./start.sh               # 常规启动，智能检查所有服务
./start.sh --restart     # 重启应用服务，保持数据库运行
./start.sh --skip-db     # 仅启动应用服务
./start.sh --force       # 强制重启所有服务
./start.sh --help        # 显示帮助信息
```

#### 3. **用户头像访问问题修复**
- ✅ **静态资源路径修复**：解决通过启动脚本启动后无法访问头像的问题
- ✅ **工作目录智能处理**：自动检测并调整工作目录，确保静态资源路径正确
- ✅ **路径兼容性**：支持Maven运行和jar包运行两种模式

### 🔧 技术改进

#### **启动脚本优化**
- **健康检查**：添加`check_service_health()`函数，检查服务是否真正可用
- **智能重启**：`stop_service_by_pid()`函数实现优雅的服务停止
- **参数解析**：`parse_args()`函数支持多种启动模式
- **状态显示**：优化服务状态显示，添加管理命令提示

#### **静态资源配置修复**
- **WebConfig.java**：添加工作目录检测和路径调整逻辑
- **UserSettingsServiceImpl.java**：统一头像上传和访问的路径处理
- **启动脚本**：jar包启动时确保在项目根目录运行

### 🚀 使用体验提升

#### **开发效率**
- **快速重启**：`./start.sh --restart` 仅重启应用服务，节省时间
- **数据库保护**：避免频繁重启Milvus等数据库服务
- **智能检测**：自动跳过已运行的健康服务

#### **操作便利性**
- **一键操作**：无需手动停止服务再启动
- **模式选择**：根据需要选择不同的启动模式
- **清晰反馈**：彩色日志和详细状态提示

### 📋 测试验证

#### **功能测试**
- ✅ 常规模式：跳过已运行的健康服务
- ✅ 重启模式：仅重启应用服务，保持数据库运行
- ✅ 强制模式：重启所有服务
- ✅ 跳过数据库模式：仅启动应用服务

#### **头像访问测试**
- ✅ 静态资源访问：`http://localhost:8080/uploads/avatars/文件名`
- ✅ HTTP 200响应：图片文件正常返回
- ✅ 路径兼容性：Maven和jar包模式均正常

### 🎯 架构说明

```
启动脚本智能化架构：
├── 参数解析 (parse_args)
├── 环境检查 (load_env_file)
├── 服务检测
│   ├── 端口检查 (check_port)
│   ├── 健康检查 (check_service_health)
│   └── 智能决策 (启动/跳过/重启)
├── 服务管理
│   ├── 数据库服务 (按需启动)
│   ├── 嵌入服务 (按需启动)
│   └── 应用服务 (支持重启)
└── 状态报告 (show_service_status)
```

### 🔄 兼容性

- ✅ **向后兼容**：原有的`./start.sh`命令功能不变
- ✅ **环境兼容**：支持macOS和Linux系统
- ✅ **工具兼容**：支持Maven Wrapper、系统Maven和jar包

### 📚 文档更新

- ✅ **README.md**：更新启动脚本使用说明
- ✅ **完整安装部署文档**：添加静态资源访问说明
- ✅ **帮助信息**：完善命令行帮助文档

---

**总结**：此次优化大大提升了FlowVO平台的开发体验，实现了智能化的服务管理，解决了头像访问问题，并提供了灵活的启动模式选择。开发者现在可以更高效地进行开发和调试工作。 



## 更新日志

### 2025年6月2日 - 文档上传功能修复
**问题修复**：
- ✅ 修复了文档标签显示为Java对象字符串的问题（如`[Ljava.lang.String;@4dd5955a`）
- ✅ 修复了前端上传请求超时和错误状态持久化问题
- ✅ 优化了文件大小限制配置（支持10MB文件上传）
- ✅ 改进了Feign客户端的参数传递机制

**技术改进**：
- 修改Feign客户端uploadFile方法的tags参数类型从`String[]`改为`List<String>`
- 在agents模块Document实体的tags字段添加`@JsonProperty`注解和`FetchType.EAGER`
- 优化了app模块DocumentManagementService中的参数转换逻辑
- 恢复了生产环境的安全配置，文档API需要认证访问

**测试验证**：
- 直接调用agents服务：标签正确返回JSON数组格式
- 通过app模块调用：标签现在也正确显示为`["测试", "配置文件"]`格式
- 完整上传流程：文档解析、向量化、存储均正常工作

### 2025年4月最新更新

#### 像素风格UI优化 【界面优化】
- **马里奥机器人**：将原有的机器人替换为马里奥风格的像素画角色
  - 红色帽子配M标志
  - 棕色头发和胡子
  - 肤色脸部，黑色眼睛
  - 红色上衣配黄色纽扣
  - 蓝色工装裤
  - 棕色鞋子
  - 尺寸放大至64x72像素，增强视觉效果
  - 保持原有的走路动画和弹跳效果

- **装饰性彩色小方块**：在对话发送栏区域添加动态装饰元素
  - 12种预定义的像素风格颜色
  - 随机大小（6-14px）和位置分布
  - 闪烁动画效果，增加视觉趣味性
  - 每10秒自动重新生成位置，保持动态感
  - 不影响用户交互，纯装饰性设计

#### 后台文档解析功能 【新增功能】
- **文档解析器架构**：
  - 创建了可扩展的文档解析器接口`DocumentParser`
  - 实现了多种文档解析器：PDF、Word、Excel、PowerPoint、文本文档
  - 通过`DocumentParserService`统一管理所有解析器

- **支持的文档格式**：
  - **PDF文档**：使用Apache PDFBox解析，提取文本内容
  - **Word文档**：支持.doc和.docx格式，使用Apache POI解析
  - **Excel表格**：支持.xls和.xlsx格式，转换为结构化JSON数据
  - **PowerPoint演示**：支持.ppt和.pptx格式，按幻灯片提取文本
  - **文本文档**：支持TXT、CSV、JSON、XML、Markdown等格式

- **智能内容处理**：
  - **Excel特殊处理**：将表格数据转换为JSON格式，便于AI分析数据关系
  - **大文档优化**：限制解析内容长度，避免内存溢出
  - **多工作表支持**：Excel文档支持多个工作表解析
  - **幻灯片分组**：PowerPoint文档按幻灯片组织内容结构

- **技术架构**：
  - 添加Apache POI依赖处理Office文档
  - 添加PDFBox依赖处理PDF文件
  - 实现base64内容解析，支持前端上传的文件
  - 集成到PixelChat服务，文档内容直接传递给AI模型

- **前后端协作**：
  - 前端上传Office文档时同时发送base64内容
  - 后端智能识别文档类型并选择合适的解析器
  - UI中不显示解析后的文档内容，保持界面简洁
  - 解析后的内容完整传递给AI进行分析

#### 文件处理和UI优化
- **简化文档附件显示**：
  - 移除消息气泡中的文档内容预览，只显示文件名和大小
  - 保持图片文件的预览功能
  - 界面更整洁，用户体验更好
  - **彻底移除用户发送消息中的文档内容显示**

- **解决大文件内存问题**：
  - 优化文件处理逻辑，对于大文件（>1MB）或Office文件不在前端读取内容
  - 提高文件大小限制从10MB到50MB
  - 添加Spring Boot文件上传配置，支持更大文件
  - 智能处理不同类型文件，避免内存溢出

- **优化Markdown显示样式**：
  - 调整行间距从1.4到1.2，内容更紧凑
  - 减少段落、列表、标题的间距
  - 优化代码块显示，提升阅读体验
  - **大幅度减少各元素间距**：段落间距1px，列表项间距0px，标题间距3px

- **侧边栏日期分组 【新功能】**：
  - 对话记录按日期智能分组：今天、昨天、7天内、更早
  - 分组标题采用像素风格设计，与整体UI保持一致
  - 提升历史对话的导航和查找体验

- **文件上传全面优化 【新功能】**：
  - **拖拽交互优化**：拖拽提示只在输入框获得焦点时显示
  - **扩展文件类型支持**：支持几乎所有常见代码文件（java, vue, py, js, ts, jsx, tsx, cpp, cs, php, rb, go, rs, swift, kt, scala, sh, sql, yml, yaml等）
  - **智能乱码检测**：自动检测文本乱码，避免无效内容存储
  - **Office文档优化**：智能识别Office文档，避免发送二进制给AI，提供合理处理建议
  - **编码优化**：使用UTF-8编码读取文本，减少乱码概率

- **提示词配置化**：
  - 将所有写死在代码中的AI提示词提取到配置文件中

#### 用户设置页面功能完善

新增了完整的用户设置管理功能，包括：

**1. 个人资料管理**
- 显示和修改用户昵称
- 实时保存昵称更改
- 用户名显示（只读，不可更改）

**2. 邮箱地址管理**
- 显示当前邮箱地址
- 修改和保存新邮箱地址
- 邮箱格式验证

**3. 密码安全管理**
- 输入当前密码进行身份验证
- 设置新密码并确认密码
- 密码强度验证（最少6位）
- 新密码与确认密码匹配验证
- 后台密码加密存储

**4. 头像管理功能**
- 圆形头像展示框架
- 图片文件选择和预览
- 支持JPG、PNG等常见图片格式
- 文件大小限制（最大5MB）
- 本地文件存储系统
- 数据库avatar_url字段存储图片路径

**技术实现特点：**
- 前后端分离架构，RESTful API设计
- 前端使用React + Chakra UI组件库
- 后端Spring Boot + JPA + MySQL
- 文件上传使用MultipartFile处理
- JWT Token身份认证
- 密码加密使用BCrypt算法
- 图片静态资源访问配置
- 完整的错误处理和用户反馈

**数据库更新：**
```sql
-- 用户表新增头像字段
ALTER TABLE users ADD COLUMN avatar_url VARCHAR(255) NULL COMMENT '头像URL';
```

**API端点：**
- `GET /api/user/settings` - 获取用户设置信息
- `POST /api/user/settings/nickname` - 更新昵称
- `POST /api/user/settings/email` - 更新邮箱
- `POST /api/user/settings/password` - 更新密码
- `POST /api/user/settings/avatar` - 上传头像
- `POST /api/user/settings/verify-password` - 验证当前密码

### 2025年5月最新更新
- **UI改进**：
  - 改进了聊天界面设计，使用下拉框替代侧边栏显示对话记录
  - 添加了对话重命名功能，可直接在列表中编辑对话标题
  - 优化对话列表显示，添加删除和重命名按钮
  - 添加Markdown渲染支持，美化AI回复显示效果

- **后端优化**：
  - 修复了大模型回复显示问题，确保错误和警告消息正确显示
  - 将API请求超时时间从10秒增加到60秒
  - 添加"正在思考中，请耐心等待"的提示信息
  - 改进了错误处理机制，确保用户能看到完整的错误信息

- **用户体验改进**：
  - 简化了创建新对话的流程
  - 改进了对话切换的用户体验
  - 添加了更清晰的UI状态提示（加载中、无对话等）

_FlowVO - 智能对话与向量检索平台&&业务MCP_

export HTTPS_PROXY=127.0.0.1:7890
export HTTP_PROXY=127.0.0.1:7890

## 🔧 最近更新

### 文档上传功能修复 (2025-06-02)

**问题描述：**
1. 前端文档上传请求无法到达后端，显示"API网络错误: 未收到响应"
2. 文档标签显示为Java类名 `[Ljava.lang.String;@4dd5955a`
3. 关闭上传页面重新打开后，前面的报错仍然显示

**根本原因：**
1. **安全配置问题**：文档管理API没有正确的认证配置
2. **Content-Type问题**：手动设置`multipart/form-data`缺少boundary参数
3. **状态管理问题**：组件未在挂载时清理错误状态

**解决方案：**

#### 1. **生产环境安全配置** 🔒
- **恢复严格认证**：文档API需要认证访问，确保生产环境安全
- **配置路径**：`app/src/main/java/org/xue/app/config/SecurityConfig.java`
```java
.requestMatchers("/api/v1/documents/**").authenticated()
```

#### 2. **文件大小限制扩展** 📁
- **agents模块**：扩展到10MB
- **app模块**：确认支持10MB
- **配置位置**：
  - `agents/src/main/resources/application.yml`
  - `app/src/main/resources/application.yml`

#### 3. **日志优化** 📝
- **关闭调试日志**：Spring Security等框架日志降级为WARN
- **配置位置**：`agents/src/main/resources/application.yml`

#### 4. **前端修复** 🔧
- **Content-Type修复**：移除手动设置，让浏览器自动生成boundary
- **状态管理修复**：DocumentUpload组件挂载时清理错误状态
- **超时配置统一**：前端、代理、后端统一使用5分钟超时

#### 5. **超时配置优化** ⏱️
- **前端API**：5分钟（300000ms）
- **Vite代理**：5分钟超时
- **后端Feign**：app→agents调用5分钟超时

**技术要点：**
- `multipart/form-data`必须包含正确的boundary参数
- 手动设置Content-Type会覆盖浏览器生成的boundary
- 组件状态管理需要在挂载时清理错误状态
- 生产环境必须启用适当的认证和授权

**架构说明：**
- 前端 → app模块（认证+路由） → agents模块（解析处理）
- app和agents解耦，agents作为插件可移植到其他项目
- app模块简单处理，agents专注文档解析和向量化

**测试确认：**
- ✅ 生产环境安全配置
- ✅ 文件大小支持10MB
- ✅ 关闭不必要的调试日志
- ✅ 修复Content-Type问题
- ✅ 修复前端状态管理
- ✅ 统一超时配置
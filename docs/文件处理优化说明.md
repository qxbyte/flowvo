# 文件处理和UI优化说明

## 改进概述

本次更新主要解决了用户反馈的三个关键问题：

### 1. 简化文档附件显示

**问题**: 上传文档时，消息气泡中显示了文档的完整内容预览，影响界面整洁性。

**解决方案**:
- 移除了消息气泡中的文档内容预览
- 只保留文件名和文件大小的简洁显示
- 图片文件仍保持预览功能，因为图片预览对用户有价值
- **新增**：彻底移除用户发送消息气泡中的文档内容显示，只保留纯文本消息

**修改文件**:
- `flowvo-ui-new/src/pages/chat/PixelChatPage.tsx` - MessageAttachments组件和handleSendMessage函数

### 2. 解决大文件内存不足问题

**问题**: 上传1.3MB的docx文件时后台报内存不足错误。

**解决方案**:
- **前端优化**:
  - 对于大文件（>1MB）或Office文件，不在前端读取文件内容
  - 只保留文件的基本信息（文件名、大小、类型）
  - 提高文件大小限制从10MB到50MB

- **后端优化**:
  - 优化文件处理逻辑，对大文件不包含完整内容
  - 添加Spring Boot文件上传配置，支持最大50MB文件
  - 对Office文档提供友好的提示信息

**修改文件**:
- `flowvo-ui-new/src/pages/chat/PixelChatPage.tsx` - readFileContent和handleFileUpload函数
- `app/src/main/java/org/xue/app/chat/service/impl/PixelChatServiceImpl.java` - buildMessageWithAttachments方法
- `app/src/main/resources/application.yml` - 添加文件上传配置

### 3. 优化Markdown显示样式

**问题**: AI回复的markdown内容行间距过大，影响阅读体验。

**解决方案**:
- **大幅度减少各种元素间距**：
  - 段落间距：4px → 1px
  - 列表项间距：2px → 0px
  - 标题间距：6px → 3px
  - 代码块内边距：8px → 6px
  - 代码块外边距：4px → 2px
- 调整字体大小层次，使标题更紧凑
- **新增**：进一步优化行间距，让内容显示更加紧凑

**修改文件**:
- `flowvo-ui-new/src/pages/chat/PixelChatPage.tsx` - CSS样式部分

### 4. 侧边栏对话记录日期分组 【新增功能】

**需求**: 将左侧对话记录按日期进行分组显示，提升用户体验。

**解决方案**:
- 实现智能日期分组：
  - **今天**：当天创建的对话
  - **昨天**：昨天创建的对话  
  - **7天内**：7天内创建的对话
  - **更早**：7天前创建的对话
- 分组标题采用像素风格设计，与整体UI保持一致
- 自动按时间顺序排列分组

**技术实现**:
- 新增 `getDateGroup()` 函数进行日期判断
- 新增 `groupConversationsByDate()` 函数进行分组处理
- 优化侧边栏渲染逻辑，支持分组显示

**修改文件**:
- `flowvo-ui-new/src/pages/chat/PixelChatPage.tsx` - 新增日期分组逻辑和渲染

### 5. 文件上传和处理全面优化 【新增功能】

#### 5.1 拖拽提示优化
**问题**: 拖拽文件提示在任意位置都会显示，影响用户体验。

**解决方案**:
- 限制拖拽提示只在输入框获得焦点时显示
- 添加输入框焦点状态管理
- 优化用户交互体验

#### 5.2 扩展文件类型支持
**问题**: 系统不支持常见的代码文件和脚本文件。

**解决方案**:
- **代码文件**: java, vue, sql, py, sh, yml, tsx, csv, cpp, c, h, cs, php, rb, go, rs, swift, kt, scala
- **配置文件**: yml, yaml, json, xml
- **Office文档**: doc, docx, xls, xlsx, ppt, pptx, pdf
- **脚本文件**: sh, sql, py等

#### 5.3 乱码检测和处理
**问题**: 文本文件读取后可能出现乱码，影响内容分析。

**解决方案**:
- **前端乱码检测**: 检测控制字符比例、特殊字符比例
- **后端乱码检测**: 检测二进制数据、替换字符
- **智能处理**: 发现乱码时提供友好提示，不存储乱码内容

#### 5.4 Office文档智能处理
**问题**: Office文档以二进制形式存储，大模型无法分析。

**解决方案**:
- **前端识别**: 自动识别Office文档格式
- **智能提示**: 提供"需要后端解析"的友好提示
- **避免二进制**: 不发送二进制内容给大模型
- **用户引导**: 建议用户提供具体分析需求

**技术实现**:
- 新增 `hasGibberish()` 函数检测乱码
- 新增 `detectFileType()` 函数识别文件类型
- 新增 `isOfficeDocument()` 后端方法判断Office文档
- 优化文件读取逻辑，支持UTF-8编码

**修改文件**:
- `flowvo-ui-new/src/pages/chat/PixelChatPage.tsx` - 文件处理逻辑优化
- `app/src/main/java/org/xue/app/chat/service/impl/PixelChatServiceImpl.java` - 后端文件处理
- `app/src/main/resources/application.yml` - 文件类型配置扩展

## 技术细节

### 文件类型支持

现在系统支持以下文件类型：
- **图片**: JPEG, PNG, GIF, WebP, SVG, BMP
- **文档**: TXT, MD, PDF, CSV
- **代码文件**: JS, TS, JSX, TSX, Vue, Python, Java, C/C++, C#, PHP, Ruby, Go, Rust, Swift, Kotlin, Scala
- **脚本文件**: Shell (.sh), SQL, Python (.py)
- **配置文件**: YAML (.yml, .yaml), JSON, XML, CSS, HTML
- **Office文档**: DOC, DOCX, XLS, XLSX, PPT, PPTX, PDF

### 文件大小限制

- **前端限制**: 50MB
- **后端限制**: 50MB（单文件），100MB（请求总大小）
- **内存优化**: 超过1MB的文件或Office文件不在前端读取内容

### 智能文件处理

- **小文件（≤1MB）**: 读取完整内容，支持内容分析
- **大文件（>1MB）**: 只保留基本信息，避免内存问题
- **Office文件**: 智能识别并提供解析提示，不发送二进制给AI
- **图片文件**: 始终读取并支持预览功能
- **乱码检测**: 自动检测文本乱码，提供友好提示
- **编码处理**: 使用UTF-8编码读取文本文件，减少乱码概率

### 日期分组逻辑

- **自动识别**: 根据对话创建时间自动分组
- **智能判断**: 准确区分今天、昨天、7天内、更早
- **动态更新**: 随时间推移自动调整分组
- **视觉设计**: 分组标题采用半透明背景，符合像素风格

## 用户体验改进

1. **界面更整洁**: 文档不再显示内容预览，消息气泡更简洁
2. **支持更大文件**: 可以上传最大50MB的文件
3. **更好的阅读体验**: markdown内容行间距大幅优化，显示更紧凑
4. **更稳定的性能**: 避免了大文件导致的内存问题
5. **更好的导航体验**: 对话记录按日期分组，快速定位历史对话
6. **智能拖拽交互**: 拖拽提示只在输入框焦点时显示，减少干扰
7. **全面文件支持**: 支持几乎所有常见的代码、配置、文档文件格式
8. **智能乱码处理**: 自动检测并避免乱码内容，提升AI分析质量
9. **Office文档优化**: 智能识别Office文档，提供合理的处理建议

## 配置说明

在`application.yml`中添加了新的文件上传配置：

```yaml
spring:
  servlet:
    multipart:
      max-file-size: 50MB      # 单个文件最大大小
      max-request-size: 100MB  # 请求最大大小
      enabled: true
```

## 视觉效果对比

### 行间距优化效果
- **优化前**: 段落间距4px，标题间距8px，列表项间距2px
- **优化后**: 段落间距1px，标题间距3px，列表项间距0px
- **效果**: 内容显示更紧凑，阅读效率提升

### 文档附件显示优化
- **优化前**: 用户消息中显示完整文档内容预览
- **优化后**: 只显示文件名和大小，界面更简洁

### 侧边栏分组效果
- **优化前**: 所有对话混合显示
- **优化后**: 按"今天"、"昨天"、"7天内"、"更早"分组显示

这些改进既解决了现有问题，又保持了系统的稳定性和用户体验，让界面更加美观和易用。 